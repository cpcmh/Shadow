<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>üåø Í∑∏Îäò Î≥¥ÎèÑ ÏßÄÎèÑ (2km Î∞òÍ≤Ω)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html,body,#map{height:100%;margin:0;padding:0;}
.blur-shadow{filter:blur(3px);opacity:0.45;}
#panel{
  position:absolute;top:10px;left:10px;z-index:9999;
  background:rgba(255,255,255,0.95);padding:8px 12px;border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.25);font-size:14px;max-width:90vw;
}
#timeControl{
  position:absolute;top:10px;right:10px;z-index:10000;
  background:rgba(255,255,255,0.95);padding:8px 12px;border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.25);font-size:14px;display:flex;gap:6px;flex-wrap:wrap;
}
#timePicker{font-size:14px;min-width:110px}
#nowBtn{font-size:13px;padding:3px 6px;cursor:pointer}
</style>
</head>
<body>
<div id="map"></div>
<div id="panel">üó∫Ô∏è ÏßÄÎèÑ Î°úÎî© Ï§ë...</div>
<div id="timeControl">
  <label for="timePicker">ÏãúÍ∞Ñ:</label>
  <input type="time" id="timePicker" step="300">
  <button id="nowBtn">ÏßÄÍ∏à</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script>
const panel = document.getElementById('panel');
const timePicker = document.getElementById('timePicker');
const nowBtn = document.getElementById('nowBtn');

const DEFAULT_LOC = [37.5665,126.9780];
let myLocation = null;
let currentDate = new Date();

const map = L.map('map',{zoomControl:true}).setView(DEFAULT_LOC,16);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',{
  maxZoom:19,attribution:'&copy; OpenStreetMap, Carto'
}).addTo(map);

const shadowLayer = L.layerGroup().addTo(map);
const footwayBaseLayer = L.layerGroup().addTo(map);
const footwayShadowLayer = L.layerGroup().addTo(map);

function sunAngles(date, lat, lon){
  const p = SunCalc.getPosition(date, lat, lon);
  return { az:(180+p.azimuth*180/Math.PI)%360, alt:p.altitude*180/Math.PI };
}
function estimateHeight(tags={}){
  if(tags.height) return parseFloat(tags.height);
  if(tags["building:levels"]) return parseFloat(tags["building:levels"])*3;
  if(tags.amenity==='school') return 20;
  if(tags.landuse==='residential') return 50;
  return 12;
}
function computeShadows(polys, az, alt){
  if(alt<=0) return [];
  const tanAlt=Math.tan(alt*Math.PI/180);
  const dir=(az+180)%360;
  return polys.map(f=>{
    const h=f.properties.height||12;
    return turf.transformTranslate(f, h/tanAlt/1000, dir, {units:'kilometers'});
  });
}

async function fetchOSM(center){
  const radius = 2.0; // ‚úÖ 2km Î∞òÍ≤Ω
  const offsetDeg = radius / 111;
  const lat = center[0], lon = center[1];
  const s = lat - offsetDeg;
  const n = lat + offsetDeg;
  const w = lon - offsetDeg;
  const e = lon + offsetDeg;

  const q = `
  [out:json][timeout:25];
  (
    way["building"](${s},${w},${n},${e});
    way["landuse"~"residential|commercial"](${s},${w},${n},${e});
    way["amenity"="school"](${s},${w},${n},${e});
    way["highway"~"footway|pedestrian|path|living_street"](${s},${w},${n},${e});
    way["highway"~"residential|service"]["sidewalk"](${s},${w},${n},${e});
    way["foot"="yes"]["highway"~"residential|service"](${s},${w},${n},${e});
  );
  out body; >; out skel qt;`;
  const controller=new AbortController();
  const timeout=setTimeout(()=>controller.abort(),20000);
  const res=await fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:q,signal:controller.signal});
  clearTimeout(timeout);
  if(!res.ok) throw new Error('Overpass API Ïò§Î•ò');
  return res.json();
}

function drawFootwaysWithShadow(footways, shadows){
  footwayBaseLayer.clearLayers();
  footwayShadowLayer.clearLayers();
  L.geoJSON({type:'FeatureCollection',features:footways},{style:{color:'#999',weight:3}}).addTo(footwayBaseLayer);
  if(shadows.length===0) return;

  const STEP_M=5, TOL_M=2;
  footways.forEach(fw=>{
    const line = turf.lineString(fw.geometry.coordinates);
    const len_km = turf.length(line,{units:'kilometers'});
    const step_km = STEP_M/1000;
    const samples = Math.max(2, Math.ceil(len_km/step_km));
    const pts = [];
    for(let i=0;i<=samples;i++){
      const p = turf.along(line, Math.min(i*step_km, len_km), {units:'kilometers'});
      pts.push(p);
    }
    for(let i=0;i<pts.length-1;i++){
      const mid = turf.midpoint(pts[i],pts[i+1]);
      let inShadow=false;
      for(const sh of shadows){
        if(turf.booleanPointInPolygon(mid, sh)){
          inShadow=true;break;
        }
        const buf = turf.buffer(mid,TOL_M/1000,{units:'kilometers'});
        if(turf.booleanIntersects(buf, sh)){
          inShadow=true;break;
        }
      }
      if(inShadow){
        L.geoJSON(
          turf.lineString([pts[i].geometry.coordinates,pts[i+1].geometry.coordinates]),
          {style:{color:'green',weight:5}}
        ).addTo(footwayShadowLayer);
      }
    }
  });
}

async function drawAll(center, date){
  try{
    panel.textContent='‚òÄÔ∏è Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Îäî Ï§ë...';
    const data = await fetchOSM(center);

    const nodes={}, ways={};
    for(const el of data.elements){
      if(el.type==='node') nodes[el.id]=[el.lon,el.lat];
      if(el.type==='way') ways[el.id]=el;
    }

    const buildings=[], footwayFeatures=[];
    for(const id in ways){
      const el=ways[id], tags=el.tags||{};
      const coords=(el.nodes||[]).map(nid=>nodes[nid]).filter(Boolean);

      if(tags.building || tags.landuse || tags.amenity){
        if(coords.length>3){
          const f=coords[0], l=coords[coords.length-1];
          if(f[0]!==l[0]||f[1]!==l[1]) coords.push(f);
          buildings.push({
            type:'Feature',
            geometry:{type:'Polygon',coordinates:[coords]},
            properties:{height:estimateHeight(tags)}
          });
        }
      }
      if(tags.highway){
        const hw = tags.highway;
        if(["motorway","trunk","primary","secondary","tertiary"].includes(hw)) continue;
        if(tags.foot==='no') continue;
        if(coords.length>1){
          footwayFeatures.push({type:'Feature',geometry:{type:'LineString',coordinates:coords},properties:{}});
        }
      }
    }

    const ang = sunAngles(date, center[0], center[1]);
    const shadows = computeShadows(buildings, ang.az, ang.alt);

    shadowLayer.clearLayers();
    L.geoJSON({type:'FeatureCollection',features:buildings},{style:{color:'#555',weight:1,fillOpacity:0.05}}).addTo(shadowLayer);
    shadows.forEach(s=>L.geoJSON(s,{style:{color:'#000',weight:0,fillOpacity:0.5},className:'blur-shadow'}).addTo(shadowLayer));

    drawFootwaysWithShadow(footwayFeatures, shadows);
    panel.textContent=`‚úÖ Í±¥Î¨º ${buildings.length} / Î≥¥ÎèÑ ${footwayFeatures.length} ‚Ä¢ ÌÉúÏñëÍ≥†ÎèÑ ${ang.alt.toFixed(1)}¬∞`;
  }catch(e){
    console.warn(e);
    panel.textContent='‚ö†Ô∏è Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå® ‚Äî Îã§Ïãú ÏãúÎèÑ';
  }
}

function initLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      myLocation=[pos.coords.latitude,pos.coords.longitude];
      map.setView(myLocation,15);
      L.circleMarker(myLocation,{radius:6,color:'#0a0'}).addTo(map);
      drawAll(myLocation,currentDate);
    },err=>{
      panel.textContent='üìå ÏúÑÏπò Í∂åÌïú ÏóÜÏùå ‚Äî Í∏∞Î≥∏ ÏúÑÏπò(ÏÑúÏö∏)';
      drawAll(DEFAULT_LOC,currentDate);
    },{enableHighAccuracy:true,timeout:8000});
  } else {
    panel.textContent='üìå ÏúÑÏπò Ï†ïÎ≥¥ ÎØ∏ÏßÄÏõê ‚Äî Í∏∞Î≥∏ ÏúÑÏπò(ÏÑúÏö∏)';
    drawAll(DEFAULT_LOC,currentDate);
  }
}

function selectedDate(){
  const d=new Date();
  if(timePicker.value){
    const [h,m]=timePicker.value.split(':'); d.setHours(+h,+m);
  }
  return d;
}
timePicker.addEventListener('input',()=>{
  currentDate=selectedDate();
  drawAll(myLocation||DEFAULT_LOC,currentDate);
});
nowBtn.addEventListener('click',()=>{
  timePicker.value=''; currentDate=new Date();
  drawAll(myLocation||DEFAULT_LOC,currentDate);
});

initLocation();
</script>
</body>
</html>
